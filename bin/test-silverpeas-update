#!/usr/bin/env bash

function msg {
  echo
  echo "$1"
}

function die {
  msg "$1"
  cd
  rm -r "$WORKING_DIR" 2>/dev/null
  exit 1
}

function runtest {
  IFS=':' read -ra RDBMS <<< "$1"
  msg "Update test for ${RDBMS[1]}"
  cd "$SILVERPEAS_HOME"
  rm -f configuration/config.properties
  echo "DB_NAME=$2" > configuration/config.properties
  echo "DB_USER=silverpeas" >> configuration/config.properties
  echo "DB_PASSWORD=silverpeas" >> configuration/config.properties
  echo "DB_SERVERTYPE=${RDBMS[1]}"  >> configuration/config.properties
  echo "DB_SERVER=${RDBMS[0]}" >> configuration/config.properties
  SILVERPEAS_HOME="$SILVERPEAS_HOME" JBOSS_HOME="$JBOSS_HOME" bin/silverpeas clean install
  ret=$?
  if [ $ret -ne 0 ]; then
    cat $SILVERPEAS_HOME/log/build-*.log
    echo
    die "Update test for ${RDBMS[1]} failed!"
  fi
  msg "Update test for ${RDBMS[1]} done"
}

PATH=$PATH:$WORKSPACE/bin
test "Z$JAVA_HOME" = "Z" && export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
test "Z$WORKSPACE" = "Z" && die "WORKSPACE environment variable isn't set!"

if [ -f core-*-build*.pom ]; then
  VERSION=`grep -oP "<version>\K6\.[0-9build\-\.]+" core-*-build*.pom`
  rm core-*-build*.pom
else
  die "No available build version to build"
fi

WORKING_DIR="$WORKSPACE/test-update"
repo=http://repository.silverpeas.org/files
source "$WORKSPACE/bin/database.conf"

mkdir "$WORKING_DIR"
cd "$WORKING_DIR"

SILVERPEAS=silverpeas-${VERSION}-wildfly15.zip
JBOSS=wildfly-15.0.1.Final.zip
SILVERPEAS_HOME="$WORKING_DIR/${SILVERPEAS%.zip}"
JBOSS_HOME="$WORKING_DIR/${JBOSS%.zip}"
customconf=$WORKSPACE/settings/CustomerSettings.xml
oracledriver=$WORKSPACE/settings/ojdbc7.jar

cd "$WORKING_DIR"
for archive in $JBOSS $SILVERPEAS; do
  msg "Fetching and extraction of the archive ${archive}..."
  wget $repo/$archive
  test $? -eq 0 || die "Cannot fetch the archive ${archive}"
  unzip $archive
  test $? -eq 0 || die "Cannot open the archive ${archive}"
  msg "... done" 
done

cp "$customconf" "$SILVERPEAS_HOME"/configuration/silverpeas/
cp "$oracledriver" "$SILVERPEAS_HOME"/bin/lib/
rm -rf ${HOME}/.gradle/caches

runtest $postgresql:POSTGRESQL "SilverUpdate"
runtest $mssql:MSSQL "SilverUpdate"
runtest $oracle:ORACLE "SILVERUPD"

cd 
rm -r $WORKING_DIR
exit 0
